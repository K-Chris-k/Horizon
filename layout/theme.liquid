<!doctype html>
<html
  class="no-js{% if request.design_mode %} shopify-design-mode{% endif %}"
  lang="{{ request.locale.iso_code }}"
>
  <head>
    <!-- Google Tag Manager -->
    <script>
    (function(w,d,s,l,i){
      w[l]=w[l]||[];
      w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0],
          j=d.createElement(s),
          dl=l!='dataLayer'?'&l='+l:'';
      j.async=true;
      j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
      f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MWSFJRN9');
    </script>
    <!-- End Google Tag Manager -->

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17164794132"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      
      // Google Ads 转化跟踪
      gtag('config', 'AW-17164794132');
      
      // Google Analytics
      gtag('config', 'G-QODMN042V3');
    </script>

    <!-- Add to Cart 转化跟踪 - 精准监听成功添加到购物车事件 -->
    <script>
    // 方案：监听主题的购物车更新事件（只在成功添加时触发）
    document.addEventListener('cart:update', function(event) {
      console.log('Cart update event detected:', event);
      
      // 从事件中获取产品信息
      var detail = event.detail || {};
      var data = detail.data || {};
      
      // 严格过滤：只在成功添加到购物车时触发（排除更新、删除、错误情况）
      if (data.source !== 'product-form-component') {
        console.log('Skipped: Not from product form');
        return;
      }
      
      // 排除添加失败的情况
      if (data.didError) {
        console.log('Skipped: Add to cart failed');
        return;
      }
      
      var variantId = detail.id || detail.sourceId || 'unknown';
      var quantity = data.itemCount || 1;
      var productId = data.productId;
      
      // 尝试从多个来源获取价格和产品信息
      var price = 0;
      var productTitle = 'Unknown Product';
      
      // 方法1: 从表单或产品页面DOM获取信息
      if (event.target) {
        var productContainer = event.target.closest('.product, .product-info, product-form-component');
        if (productContainer) {
          // 查找价格元素
          var priceElement = productContainer.querySelector('[data-product-price] .money, .price .money, .product-price .money, [data-price]');
          if (priceElement) {
            var priceText = priceElement.getAttribute('data-price') || priceElement.textContent;
            price = parseFloat(priceText.replace(/[^0-9.]/g, '')) || 0;
          }
          
          // 查找标题元素
          var titleElement = productContainer.querySelector('[data-product-title], .product__title, h1');
          if (titleElement) {
            productTitle = titleElement.textContent.trim();
          }
        }
      }
      
      // 方法2: 如果是产品详情页，从页面元素获取
      if (price === 0) {
        var mainProduct = document.querySelector('.product, [data-product-id]');
        if (mainProduct) {
          var priceEl = mainProduct.querySelector('.price .money, [data-product-price] .money');
          if (priceEl) {
            price = parseFloat(priceEl.textContent.replace(/[^0-9.]/g, '')) || 0;
          }
          var titleEl = mainProduct.querySelector('h1, [data-product-title]');
          if (titleEl) {
            productTitle = titleEl.textContent.trim();
          }
        }
      }
      
      // 方法3: 从产品卡片获取信息（用于快速添加）
      if (price === 0 && productId) {
        var productCard = document.querySelector('[data-product-id="' + productId + '"]');
        if (productCard) {
          var cardPrice = productCard.querySelector('.price .money, [data-product-price]');
          if (cardPrice) {
            price = parseFloat(cardPrice.textContent.replace(/[^0-9.]/g, '')) || 0;
          }
          var cardTitle = productCard.querySelector('[data-product-title], .product-title, h3, h2');
          if (cardTitle) {
            productTitle = cardTitle.textContent.trim();
          }
        }
      }
      
      console.log('Tracking add_to_cart:', {
        productTitle: productTitle,
        price: price,
        variantId: variantId,
        quantity: quantity,
        productId: productId
      });
      
      // 发送 GA4 add_to_cart 事件
      gtag('event', 'add_to_cart', {
        currency: '{{ shop.currency }}',
        value: price * quantity,
        items: [{
          item_id: variantId,
          item_name: productTitle,
          price: price,
          quantity: quantity
        }]
      });
      
      // 发送 Google Ads 转化事件
      gtag('event', 'conversion', {
        'send_to': 'AW-17164794132/WzBKCKjK6-YaEJTy5_g_',
        'value': price * quantity,
        'currency': '{{ shop.currency }}'
      });
    });
    </script>

    {%- if settings.favicon != blank -%}
      <link
        rel="icon"
        type="image/png"
        href="{{ settings.favicon | image_url: width: 32, height: 32 }}"
      >
    {%- endif -%}

    {% comment %} Force scroll to top before any other scripts run {% endcomment %}
    <script>
      // Immediately scroll to top on page load, before any view transitions
      if (window.scrollY !== 0) {
        window.scrollTo(0, 0);
      }
      // Ensure manual scroll restoration
      if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
      }
    </script>

    {% comment %} This a way to wait for main content to load when navigating to a new page so that the view transitions can work consistently {% endcomment %}
    <link
      rel="expect"
      href="#MainContent"
      blocking="render"
      id="view-transition-render-blocker"
    >

    {%- render 'meta-tags' -%}
    {%- render 'stylesheets' -%}
    {%- render 'fonts' -%}
    {%- render 'scripts' -%}
    {%- render 'theme-styles-variables' -%}
    {%- render 'color-schemes' -%}

    {% if request.design_mode %}
      {%- render 'theme-editor' -%}
    {% endif %}

    {{ content_for_header }}
    <!-- Hotjar Tracking Code for New website -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:6564428,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>


  </head>

  <body class="page-width-{{ settings.page_width }} card-hover-effect-{{ settings.card_hover_effect }}">
    {% render 'skip-to-content-link', href: '#MainContent', text: 'accessibility.skip_to_text' %}
    <div id="header-group">
      {% sections 'header-group' %}
    </div>

    <script
      src="{{ 'critical.js' | asset_url }}"
      type="module"
      async
      blocking="render"
    ></script>

    <main
      id="MainContent"
      class="content-for-layout"
      role="main"
      data-page-transition-enabled="{{ settings.page_transition_enabled }}"
      data-product-transition="{{ settings.transition_to_main_product }}"
      data-template="{{ template }}"
    >
      {{ content_for_layout }}
    </main>

    {% sections 'footer-group' %}

    {% render 'search-modal' %}

    {% if settings.quick_add or settings.mobile_quick_add %}
      {% render 'quick-add-modal' %}
    {% endif %}

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MWSFJRN9"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- Begin Checkout 转化跟踪 -->
    <script>
    // 监听结账按钮点击
    document.addEventListener('DOMContentLoaded', function() {
      var checkoutButton = document.querySelector('#checkout, button[name="checkout"], .cart__checkout-button');
      
      if (checkoutButton) {
        checkoutButton.addEventListener('click', function(e) {
          // 获取购物车总价
          var cartTotal = 0;
          var cartTotalElement = document.querySelector('[data-cart-total], .cart__total-price, .totals__total-value');
          
          if (cartTotalElement) {
            cartTotal = parseFloat(cartTotalElement.textContent.replace(/[^0-9.]/g, '')) || 0;
          }
          
          console.log('Begin checkout event fired, cart total:', cartTotal);
          
          // 发送 GA4 begin_checkout 事件
          gtag('event', 'begin_checkout', {
            currency: '{{ shop.currency }}',
            value: cartTotal
          });
          
          // 发送 Google Ads 转化事件 - Begin checkout
          gtag('event', 'conversion', {
            'send_to': 'AW-17164794132/yK-nCKmQj5AbEJTy5_g_',
            'value': cartTotal,
            'currency': '{{ shop.currency }}'
          });
        });
      }
    });
    </script>

    <!-- Purchase 转化跟踪 - 仅在订单确认页面 -->
    {% if template contains 'customers/order' %}
      <script>
      // 在订单确认页面触发购买转化
      {% if order %}
        var orderTotal = {{ order.total_price | money_without_currency | remove: ',' }};
        var orderId = '{{ order.order_number }}';
        
        console.log('Purchase conversion fired:', {
          orderId: orderId,
          total: orderTotal
        });
        
        // 发送 GA4 purchase 事件
        gtag('event', 'purchase', {
          transaction_id: orderId,
          value: orderTotal,
          currency: '{{ shop.currency }}',
          items: [
            {% for line_item in order.line_items %}
            {
              item_id: '{{ line_item.variant_id }}',
              item_name: '{{ line_item.title | escape }}',
              price: {{ line_item.price | money_without_currency | remove: ',' }},
              quantity: {{ line_item.quantity }}
            }{% unless forloop.last %},{% endunless %}
            {% endfor %}
          ]
        });
        
        // 发送 Google Ads 转化事件 - Purchase (第一个)
        gtag('event', 'conversion', {
          'send_to': 'AW-17164794132/uAMUCJvH6NYaEJTy5_g_',
          'value': orderTotal,
          'currency': '{{ shop.currency }}',
          'transaction_id': orderId
        });
        
        // 发送 Google Ads 转化事件 - Purchase (第二个 - 购买)
        gtag('event', 'conversion', {
          'send_to': 'AW-17164794132/IYbVCKr2k7kbEJTy5_g_',
          'value': orderTotal,
          'currency': '{{ shop.currency }}',
          'transaction_id': orderId
        });
      {% endif %}
      </script>
    {% endif %}

  </body>
</html>
