
<style> 
media-gallery.media-gallery--grid .media-gallery__grid .product-media-container{
  display:  block !important;
}
@media (max-width: 749px) {
  media-gallery.media-gallery--grid .media-gallery__grid .product-media-container{
  display:  block;
}
  slideshow-container{}
}

</style>

{% assign block_settings = block.settings %}

{%- if block_settings.zoom -%}
  <script
    src="{{ 'zoom-dialog.js' | asset_url }}"
    type="module"
  ></script>
{%- endif -%}

{%- liquid
  assign selected_product = closest.product
  assign selected_variant_media = selected_product.selected_or_first_available_variant.featured_media
  assign first_3d_model = selected_product.media | where: 'media_type', 'model' | first

  # Get current selected variant options for initial filtering
  assign selected_variant = selected_product.selected_or_first_available_variant
  assign variant_option_values = ''
  for option in selected_variant.options
    # Replace spaces with underscores to match JS logic
    assign option_value = option | replace: ' ', '_'
    if variant_option_values == blank
      assign variant_option_values = option_value
    else
      assign variant_option_values = variant_option_values | append: '_' | append: option_value
    endif
  endfor
  # Now variant_option_values contains something like "250W_1_Gang"

  if block_settings.slideshow_controls_style == 'thumbnails'
    assign controls_on_media = false
  else
    assign controls_on_media = true
  endif

  assign render_slideshow_controls = false

  if block_settings.media_presentation == 'carousel' or block_settings.slideshow_controls_style == block_settings.slideshow_mobile_controls_style
    assign render_slideshow_controls = true
  endif

  assign render_mobile_slideshow_controls = false

  if block_settings.slideshow_controls_style != block_settings.slideshow_mobile_controls_style
    assign slideshow_controls_class = 'mobile:hidden'

    if block_settings.slideshow_mobile_controls_style != 'hint'
      assign render_mobile_slideshow_controls = true
    endif
  endif

  assign slideshow_controls_style = block_settings.slideshow_controls_style
  # Use a counter instead of dots when there are many images to avoid cropping/overflow.
  if slideshow_controls_style == 'dots' and selected_product.media.size > 15
    assign slideshow_controls_style = 'counter'
  endif

  assign render_slideshow_arrows = false

  if selected_product.media.size <= 1
    assign slideshow_class = 'product-media-gallery__slideshow--single-media slideshow--single-media'
  else
    assign slideshow_class = ''

    if block_settings.media_presentation == 'carousel'
      assign render_slideshow_arrows = true
    endif
  endif

  if slideshow_controls_style == 'thumbnails'
    assign pagination_position = block_settings.thumbnail_position
  else
    assign pagination_position = 'center'
  endif

  # correct discrepancy between position settings for thumbnails and other controls
  if pagination_position == 'bottom'
    assign pagination_position = 'center'
  endif

  assign icons_position = 'center'

  # Put the icons on the opposite side of the pagination controls
  if block_settings.slideshow_controls_position == 'on_media'
    if pagination_position == 'left'
      assign icons_position = 'right'
    elsif pagination_position == 'right'
      assign icons_position = 'left'
    endif
  endif
-%}

{%- liquid
  # Show all product media - no filtering
  # If selected_variant_media exists, show it first, then all others
  # Otherwise, show all media in original order
  
  if selected_variant_media
    # Show selected variant image first, then all other media
    assign sorted_media = selected_product.media | where: 'id', selected_variant_media.id
    
    for media in selected_product.media
      if media.id != selected_variant_media.id
        assign found_media = selected_product.media | where: 'id', media.id
        assign sorted_media = sorted_media | concat: found_media
      endif
    endfor
  else
    # Show all media in original order
    assign sorted_media = selected_product.media
  endif
  
  assign has_image_drop = sorted_media | has: 'media_type', 'image'

  # Determine if we're in single column mode (carousel or grid with one column)
  assign is_single_column = false
  if block_settings.media_presentation == 'carousel' or sorted_media.size == 1 or block_settings.media_presentation == 'grid' and block_settings.media_columns == 'one'
    assign is_single_column = true
  endif

  # Check if we need both sizes (for large first image in two-column grid)
  assign needs_both_sizes = false
  if block_settings.media_presentation == 'grid' and block_settings.media_columns == 'two' and block_settings.large_first_image
    assign needs_both_sizes = true
  endif

  # Calculate sizes using utility snippet
  if needs_both_sizes
    # Calculate sizes for single column (first image)
    capture sizes_single
      render 'util-product-media-sizes-attr', block: block, section: section, settings: settings, is_first_image: true, is_single_column: true, needs_both_sizes: true
    endcapture
    assign sizes_single = sizes_single | strip
  endif

  # Calculate sizes value for regular grid/carousel items
  capture sizes
    render 'util-product-media-sizes-attr', block: block, section: section, settings: settings, is_first_image: false, is_single_column: is_single_column, needs_both_sizes: needs_both_sizes
  endcapture
  assign sizes = sizes | strip
-%}
{%- if has_image_drop -%}
  <script
    src="{{ 'drag-zoom-wrapper.js' | asset_url }}"
    type="module"
  ></script>
{%- endif -%}

{% style %}
  {% unless block_settings.aspect_ratio == 'adapt' %}
    .product-media-container {
      --media-preview-ratio: {{ block_settings.aspect_ratio }};
    }

    {% if block_settings.constrain_to_viewport %}
      .product-media-container.constrain-height {
        background-color: var(--color-background);
      }

      .product-media-container.constrain-height:has(.product-media-constraint-wrapper) {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Mobile constraint wrapper sizing - use width-based approach since max-height is disabled */
      .product-media-constraint-wrapper {
        width: 100%;
        max-width: 100%;
        flex-shrink: 0;
      }

      /* Desktop constraint wrapper sizing */
      @media screen and (min-width: 750px) {
        .product-media-constraint-wrapper {
          width: min(100%, calc(var(--constrained-height) * {{ block_settings.aspect_ratio }}));
        }
      }
    {% endif %}

    /* Constrain all deferred-media content to parent bounds when specific aspect ratio is set */
    .product-media-container:not(.dialog-zoomed-gallery *) .product-media deferred-media,
    .product-media-container:not(.dialog-zoomed-gallery *) .product-media product-model {
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
    }

    /* Ensure video and iframe elements respect container aspect ratio */
    .product-media-container:not(.dialog-zoomed-gallery *) .product-media deferred-media video,
    .product-media-container:not(.dialog-zoomed-gallery *) .product-media deferred-media iframe {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* 3D models need special handling since they don't support object-fit */
    .product-media-container:not(.dialog-zoomed-gallery *) .product-media product-model model-viewer {
      width: 100%;
      height: 100%;
    }

    /* Clear gallery aspect ratio for zoom dialog - let media display at natural aspect ratios */
    .dialog-zoomed-gallery .product-media {
      --gallery-aspect-ratio: var(--ratio);
    }
  {% endunless %}

  {% if block_settings.aspect_ratio == 'adapt' and block_settings.constrain_to_viewport %}
    .media-fit-{{ block_settings.media_fit }} {
      --product-media-fit: {{ block_settings.media_fit }};
    }

    /* Media fit for all media elements */
    .media-fit-{{ block_settings.media_fit }} :is(img, video, iframe, .deferred-media__poster-image) {
      object-fit: {{ block_settings.media_fit }};
      width: 100%;
      height: 100%;
    }

    /* 3D Models (no object-fit support, just sizing) */
    .media-fit-{{ block_settings.media_fit }} model-viewer {
      width: 100%;
      height: 100%;
    }
  {% endif %}

  {% unless block_settings.aspect_ratio == 'adapt' and block_settings.constrain_to_viewport %}
    .media-fit-cover {
      --product-media-fit: cover;
    }

    /* Media fit for all media elements - default to cover */
    .media-fit-cover :is(img, video, iframe, .deferred-media__poster-image) {
      object-fit: cover;
      width: 100%;
      height: 100%;
    }

    /* 3D Models (no object-fit support, just sizing) */
    .media-fit-cover model-viewer {
      width: 100%;
      height: 100%;
    }
  {% endunless %}

  /* Add background color so carousel arrows' mix-blend-mode works correctly even on transparent areas. */
  {% if block_settings.media_fit == 'contain' %}
    .media-fit-contain :is(img, .deferred-media__poster-image) {
      background-color: var(--color-background);
    }
  {% endif %}
{% endstyle %}

{% liquid
  assign product_media_container_class = 'product-media-container'
  if block_settings.constrain_to_viewport
    assign product_media_container_class = product_media_container_class | append: ' constrain-height'
  endif
  if block_settings.aspect_ratio != 'adapt'
    assign product_media_container_class = product_media_container_class | append: ' media-fit-cover'
  elsif block_settings.constrain_to_viewport
    assign product_media_container_class = product_media_container_class | append: ' media-fit-' | append: block_settings.media_fit
  else
    assign product_media_container_class = product_media_container_class | append: ' media-fit-contain'
  endif

  if block.settings.aspect_ratio == 'adapt'
    assign lowest_aspect_ratio = 50
    assign lowest_aspect_ratio_index = 0

    for media in sorted_media
      # Find the media with the lowest aspect ratio (tallest)

      if media.preview_image and media.preview_image.aspect_ratio
        if media.preview_image.aspect_ratio < lowest_aspect_ratio
          assign lowest_aspect_ratio = media.preview_image.aspect_ratio
          assign lowest_aspect_ratio_index = forloop.index0
        endif
      endif
    endfor
  endif
%}

<media-gallery
  class="
    spacing-style
    sticky-content
    {% if block_settings.media_presentation == 'grid' %}
      media-gallery--{{ block_settings.media_columns }}-column
      {% if block_settings.media_columns == "two" and block_settings.large_first_image%}media-gallery--large-first-image{% endif %}
    {% endif %}
    media-gallery--{{ block_settings.media_presentation }}
    {% if block_settings.slideshow_mobile_controls_style == 'hint' %}
      media-gallery--hint
    {% endif %}
    {% if block_settings.extend_media %}
      media-gallery--extend
    {% endif %}
  "
  style="{% render 'spacing-style', settings: block_settings %} --thumbnail-width: {{ block_settings.thumbnail_width }}px; --media-radius: {{ block_settings.media_radius }}px;{% if block_settings.icons_style contains 'large' %} --slideshow-icon-padding: 0px;{% endif %}--image-gap: {{ block_settings.image_gap }}px;{% unless block_settings.aspect_ratio == 'adapt' %} --gallery-aspect-ratio: {{ block_settings.aspect_ratio }};{% endunless %}"
  data-presentation="{{ block_settings.media_presentation }}"
  data-media-count="{{ sorted_media.size }}"
  data-total-product-media="{{ selected_product.media.size }}"
  {{ block.shopify_attributes }}
>
  {% capture slides %}
    {% for media in sorted_media %}
      {% capture children %}
        {%- liquid
            if needs_both_sizes and forloop.first
              assign media_sizes = sizes_single
            else
              assign media_sizes = sizes
            endif
        -%}
{% if block_settings.aspect_ratio != 'adapt' and block_settings.constrain_to_viewport %}
          <div class="product-media-constraint-wrapper">
            {%- render 'product-media', media: media, sizes: media_sizes, is_main_product_media: forloop.first -%}
          </div>
        {% else %}
          {%- render 'product-media', media: media, sizes: media_sizes, is_main_product_media: forloop.first -%}
        {% endif %}
      {% endcapture %}
      {% capture class %}
        {%- liquid
          # Check if media alt matches current variant - add variant-filtered if not
          assign media_alt_clean = media.alt | strip | replace: ' ', '_'
          assign should_hide = false
          if media_alt_clean != variant_option_values and media_alt_clean != blank
            assign should_hide = true
          endif
        -%}
        {{ product_media_container_class }} product-media-container--{{ media.media_type }}{% if block.settings.zoom %} product-media-container--zoomable{% endif %}{% if forloop.index0 == lowest_aspect_ratio_index and block.settings.aspect_ratio == 'adapt' %} product-media-container--tallest{% endif %}{% if should_hide %} variant-filtered{% endif %}
      {% endcapture %}
      {% if block_settings.aspect_ratio == 'adapt' %}
        {% capture style %}
          --media-preview-ratio: {{ media.preview_image.aspect_ratio | default: 1.0 }};
        {% endcapture %}
      {% endif %}
      {% if block_settings.zoom and media.media_type == 'model' %}
        {%- capture attributes -%}data-media-index="{{ forloop.index0 }}" data-media-alt="{{ media.alt | escape }}"{% if settings.transition_to_main_product and forloop.first %} data-view-transition-type="product-image-transition"{% endif %}{% endcapture -%}
      {% elsif block_settings.zoom %}
        {%- capture attributes -%}data-media-index="{{ forloop.index0 }}" data-media-alt="{{ media.alt | escape }}" on:click="#zoom-dialog-{{ block.id }}/open/{{ forloop.index0 }}"{% if settings.transition_to_main_product and forloop.first %} data-view-transition-type="product-image-transition"{% endif %}{% endcapture -%}
      {% else %}
        {%- capture attributes -%}data-media-index="{{ forloop.index0 }}" data-media-alt="{{ media.alt | escape }}"{% if settings.transition_to_main_product and forloop.first %} data-view-transition-type="product-image-transition"{% endif %}{% endcapture -%}
      {% endif %}

      {% render 'slideshow-slide',
        index: forloop.index0,
        children: children,
        class: class,
        style: style,
        attributes: attributes,
        media_fit: block_settings.media_fit,
      %}
    {% endfor %}
  {% endcapture %}

  {% if sorted_media.size > 1 %}
    {% capture controls %}
      {% if render_slideshow_controls %}
        {%- render 'slideshow-controls',
          class: slideshow_controls_class,
          style: slideshow_controls_style,
          item_count: sorted_media.size,
          thumbnails: sorted_media,
          controls_on_media: controls_on_media,
          pagination_position: pagination_position,
          aspect_ratio: block_settings.aspect_ratio
        -%}
      {% endif %}

      {% if render_mobile_slideshow_controls %}
        {%- render 'slideshow-controls',
          class: 'desktop:hidden media-gallery__mobile-controls',
          style: block_settings.slideshow_mobile_controls_style,
          item_count: sorted_media.size,
          controls_on_media: true,
          pagination_position: 'center',
        -%}
      {% endif %}
    {% endcapture %}
  {% endif %}

  {% if render_slideshow_arrows %}
    {% capture slideshow_arrows %}
      {% render 'slideshow-arrows', class: 'mobile:hidden', icon_style: block_settings.icons_style, icon_shape: settings.icons_shape %}
    {% endcapture %}
  {% endif %}

  {% if block_settings.media_presentation == 'grid' %}
    {%- comment -%} Grid Mode: Render all media directly without slideshow {%- endcomment -%}
    <div class="media-gallery__grid">
      {% for media in sorted_media %}
        {%- liquid
          if needs_both_sizes and forloop.first
            assign media_sizes = sizes_single
          else
            assign media_sizes = sizes
          endif
        -%}
        {% capture container_class %}{%- liquid
          # Check if media alt matches current variant - add variant-filtered if not
          assign media_alt_clean = media.alt | strip | replace: ' ', '_'
          assign should_hide = false
          if media_alt_clean != variant_option_values and media_alt_clean != blank
            assign should_hide = true
          endif
        -%}{{ product_media_container_class }} product-media-container--{{ media.media_type }}{% if block.settings.zoom %} product-media-container--zoomable{% endif %}{% if forloop.index0 == lowest_aspect_ratio_index and block.settings.aspect_ratio == 'adapt' %} product-media-container--tallest{% endif %}{% if should_hide %} variant-filtered{% endif %}{% endcapture %}
        {% capture container_style %}{% if block_settings.aspect_ratio == 'adapt' %}--media-preview-ratio: {{ media.preview_image.aspect_ratio | default: 1.0 }};{% endif %}{% endcapture %}
        {% capture container_attributes %}data-media-index="{{ forloop.index0 }}" data-media-alt="{{ media.alt | escape }}"{% if block_settings.zoom and media.media_type != 'model' %} on:click="#zoom-dialog-{{ block.id }}/open/{{ forloop.index0 }}"{% endif %}{% if settings.transition_to_main_product and forloop.first %} data-view-transition-type="product-image-transition"{% endif %}{% endcapture %}
        
        <div class="{{ container_class }}" style="{{ container_style }}" {{ container_attributes }}>
          {% if block_settings.aspect_ratio != 'adapt' and block_settings.constrain_to_viewport %}
            <div class="product-media-constraint-wrapper">
              {%- render 'product-media', media: media, sizes: media_sizes, is_main_product_media: forloop.first -%}
            </div>
          {% else %}
            {%- render 'product-media', media: media, sizes: media_sizes, is_main_product_media: forloop.first -%}
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    {%- comment -%} Carousel Mode: Use slideshow component {%- endcomment -%}
    {% render 'slideshow',
      ref: 'slideshow',
      class: slideshow_class,
      slides: slides,
      slide_count: sorted_media.size,
      slideshow_arrows: slideshow_arrows,
      arrows_position: icons_position,
      controls: controls
    %}
  {% endif %}

  {%- comment -%} Mobile Grid Navigation Arrows - Only for grid mode {%- endcomment -%}
  {% if sorted_media.size > 1 and block_settings.media_presentation == 'grid' %}
    <div class="mobile-grid-nav mobile:block desktop:hidden">
      <button
        type="button"
        class="mobile-grid-nav__button mobile-grid-nav__button--prev"
        aria-label="Previous image"
        data-action="prev"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <button
        type="button"
        class="mobile-grid-nav__button mobile-grid-nav__button--next"
        aria-label="Next image"
        data-action="next"
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  {% endif %}

  {%- comment -%} Mobile thumbnail navigation - Only for grid mode {%- endcomment -%}
  {% if sorted_media.size > 1 and block_settings.media_presentation == 'grid' %}
    <div class="mobile-thumbnail-nav mobile:block desktop:hidden">
      <div class="mobile-thumbnail-nav__container">
        {% for media in sorted_media %}
          {%- liquid
            # 检查缩略图是否匹配当前variant
            assign media_alt_clean = media.alt | strip | replace: ' ', '_'
            assign should_hide_thumb = false
            if media_alt_clean != variant_option_values and media_alt_clean != blank
              assign should_hide_thumb = true
            endif
          -%}
          <button
            type="button"
            class="mobile-thumbnail-nav__item {% if forloop.first %}active{% endif %}{% if should_hide_thumb %} thumbnail-hidden{% endif %}"
            data-media-index="{{ forloop.index0 }}"
            data-media-alt="{{ media.alt | escape }}"
            aria-label="View image {{ forloop.index }}"
          >
            {{
              media.preview_image
              | image_url: width: 200
              | image_tag:
                loading: 'eager',
                widths: '100, 200',
                alt: media.alt
            }}
          </button>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {%- if block_settings.zoom -%}
    <zoom-dialog
      ref="zoomDialogComponent"
      id="zoom-dialog-{{ block.id }}"
    >
      <dialog
        ref="dialog"
        on:keydown="/handleKeyDown"
        scroll-lock
      >
        <button
          type="button"
          class="button button-unstyled close-button dialog-zoomed-gallery__close-button"
          aria-label="{{ 'actions.close' | t }}"
          on:click="/close"
        >
          <span class="visually-hidden">{{ 'actions.close' | t }}</span>
          {{ 'icon-close.svg' | inline_asset_content }}
        </button>
        <div class="dialog-thumbnails-list-container">
          <scroll-hint
            class="dialog-thumbnails-list list-unstyled"
            ref="thumbnails"
          >
            {% if sorted_media.size > 1 %}
              {%- for media in sorted_media -%}
                {% liquid
                  assign aspect_ratio = block_settings.aspect_ratio
                  if block_settings.aspect_ratio == 'adapt'
                    assign aspect_ratio = media.preview_image.aspect_ratio | default: 1.0
                  endif
                %}
                <button
                  type="button"
                  class="button button-unstyled dialog-thumbnails-list__thumbnail"
                  aria-label="{{ 'accessibility.scroll_to' | t: title: media.alt | default: media.media_type }}"
                  on:click="/handleThumbnailClick/{{ forloop.index0 }}"
                  on:pointerenter="/handleThumbnailPointerEnter/{{ forloop.index0 }}"
                  style="--aspect-ratio: {{ aspect_ratio }}; --gallery-aspect-ratio: {{ aspect_ratio }};"
                  {% if forloop.first %}
                    aria-selected="true"
                  {% endif %}
                >
                  {% liquid
                    assign focal_point_style = ''
                    if media.presentation.focal_point != blank
                      assign focal_point_style = 'object-position: ' | append: media.presentation.focal_point | append: ';'
                    endif
                  %}
                  {{
                    media.preview_image
                    | image_url: width: 1024
                    | image_tag:
                      loading: 'lazy',
                      sizes: 'auto, 110, (min-width: 750px) 160',
                      widths: '240, 352, 832, 1200',
                      alt: media.alt,
                      style: focal_point_style
                    | escape
                  }}
                </button>
              {%- endfor -%}
            {% endif %}
          </scroll-hint>
        </div>
        {% if sorted_media.size > 1 %}
          <button
            type="button"
            class="zoom-dialog-nav zoom-dialog-nav--prev"
            aria-label="Previous image"
            id="zoom-prev-{{ block.id }}"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button
            type="button"
            class="zoom-dialog-nav zoom-dialog-nav--next"
            aria-label="Next image"
            id="zoom-next-{{ block.id }}"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="zoom-dialog-counter" id="zoom-counter-{{ block.id }}">
            <span class="zoom-dialog-counter__current">1</span>
            <span class="zoom-dialog-counter__separator"> of </span>
            <span class="zoom-dialog-counter__total">{{ sorted_media.size }}</span>
          </div>
        {% endif %}
        
        <ul
          class="dialog-zoomed-gallery list-unstyled"
        >
          {%- for media in sorted_media -%}
            {%- comment -%}
              NOTE: Don't add variant-filtered class to zoom images at render time
              Let JavaScript filter them dynamically when zoom opens
            {%- endcomment -%}
            <li
              id="product-{{ media.id}}-{{ forloop.index }}"
              class="{{ product_media_container_class | remove: 'media-fit-cover' }} product-media-container--{{ media.media_type }}{% if media.media_type == 'image' %} product-media-container--zoomable{% endif %}"
              style="{% if block_settings.aspect_ratio == 'adapt' %} --media-preview-ratio: {{ media.preview_image.aspect_ratio | default: 1.0 }};{% endif %}"
              data-zoom-index="{{ forloop.index0 }}"
              data-media-alt="{{ media.alt | escape }}"
              ref="media[]"
            >
              {% if media.media_type == 'image' %}
                <drag-zoom-wrapper class="product-media__drag-zoom-wrapper">
                  {%- render 'product-media',
                    media: media,
                    sizes: '100vw',
                    loading: 'lazy',
                    is_main_product_media: forloop.first
                  -%}
                </drag-zoom-wrapper>
              {% else %}
                {%- render 'product-media',
                  media: media,
                  sizes: '100vw',
                  loading: 'lazy',
                  is_main_product_media: forloop.first
                -%}
              {% endif %}
            </li>
          {%- endfor -%}
        </ul>
      </dialog>
    </zoom-dialog>
  {%- endif -%}

  {%- if first_3d_model -%}
    <link
      id="ModelViewerStyle"
      rel="stylesheet"
      href="https://cdn.shopify.com/shopifycloud/model-viewer-ui/assets/v1.0/model-viewer-ui.css"
      media="print"
      onload="this.media='all'"
    >
    <script>
      window.ProductModel = {
        loadShopifyXR() {
          Shopify.loadFeatures([
            {
              name: 'shopify-xr',
              version: '1.0',
              onLoad: this.setupShopifyXR.bind(this),
            },
          ]);
        },

        setupShopifyXR(errors) {
          if (errors) return;

          if (!window.ShopifyXR) {
            document.addEventListener('shopify_xr_initialized', () => this.setupShopifyXR());
            return;
          }

          document.querySelectorAll('[id^="ProductModelJSON-"]').forEach((modelJSON) => {
            window.ShopifyXR.addModels(JSON.parse(modelJSON.textContent));
            modelJSON.remove();
          });
          window.ShopifyXR.setupXRElements();
        },
      };

      window.ProductModel.loadShopifyXR();
    </script>
  {%- endif -%}
</media-gallery>

{% stylesheet %}
  /* 全局：强制禁用所有 variant 切换相关的过渡动画 */
  .media-gallery--grid .product-media-container,
  .media-gallery--grid .product-media-container *,
  .media-gallery--grid .product-media,
  .media-gallery--grid .product-media__image {
    transition: none !important;
    animation: none !important;
  }
  
  /* 性能优化：启用硬件加速和即时渲染 */
  .media-gallery--grid .product-media-container {
    will-change: opacity, visibility;
    transform: translateZ(0);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
  }
  
  .media-gallery--grid .product-media__image {
    will-change: auto;
    transform: translateZ(0);
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }
  
  /* 桌面端：使用 opacity + position 实现无闪烁切换 */
  @media screen and (min-width: 750px) {
    /* Grid 容器设置为相对定位，为绝对定位的子元素提供定位上下文 */
    .media-gallery--grid .media-gallery__grid {
      position: relative;
    }
    
    /* 所有图片都使用绝对定位叠加，预加载但隐藏 */
    .media-gallery--grid .media-gallery__grid .product-media-container.variant-filtered {
      position: absolute !important;
      top: 0;
      left: 0;
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
      z-index: -1 !important;
      /* 保持 DOM 结构，但完全不可见和不可交互 */
    }
    
    /* 可见图片立即显示，无过渡动画 */
    .media-gallery--grid .media-gallery__grid .product-media-container:not(.variant-filtered) {
      position: relative !important;
      opacity: 1 !important;
      visibility: visible !important;
      pointer-events: auto !important;
      z-index: 1 !important;
      /* 移除 transition，实现立即切换 */
    }
  }
  
  /* 移动端：使用绝对定位叠加所有图片 - 覆盖 base.css 的样式 */
  @media screen and (max-width: 749px) {
    /* Grid 容器设置为相对定位 - 覆盖 base.css 的 display: block */
    .media-gallery--grid .media-gallery__grid {
      position: relative !important;
      display: block !important;
      min-height: 300px; /* 设置最小高度避免布局跳动 */
      /* 覆盖 base.css 的 horizontal scroll 样式 */
      white-space: normal !important;
      overflow-x: visible !important;
      overflow-y: visible !important;
    }
    
    /* 清除 base.css 的伪元素 */
    .media-gallery--grid .media-gallery__grid::after {
      content: none !important;
      display: none !important;
    }
    
    /* 所有图片绝对定位叠加 - 覆盖 base.css 的 display: block/inline-block */
    .media-gallery--grid .media-gallery__grid .product-media-container {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: auto !important;
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
      /* 覆盖 base.css 的样式 */
      display: block !important;
      margin: 0 !important;
      white-space: normal !important;
      /* 移除 transition，实现立即切换 */
    }
    
    /* 第一张可见图片默认显示（在 JS 添加 mobile-current 之前） */
    .media-gallery--grid .media-gallery__grid .product-media-container:not(.variant-filtered):first-of-type {
      position: relative !important;
      opacity: 1 !important;
      visibility: visible !important;
      pointer-events: auto !important;
      z-index: 2 !important;
    }
    
    /* 当前显示的图片 - 立即显示（优先级更高） */
    .media-gallery--grid .media-gallery__grid .product-media-container.mobile-current:not(.variant-filtered) {
      position: relative !important;
      opacity: 1 !important;
      visibility: visible !important;
      pointer-events: auto !important;
      z-index: 2 !important;
      /* 移除 transition，实现立即切换 */
    }
    
    /* 非当前的图片隐藏（即使是可见的variant） */
    .media-gallery--grid .media-gallery__grid .product-media-container:not(.mobile-current):not(.variant-filtered) {
      position: absolute !important;
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
    }
    
    /* 被过滤的图片完全隐藏 */
    .media-gallery--grid .media-gallery__grid .product-media-container.variant-filtered {
      position: absolute !important;
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
      z-index: -1 !important;
    }
  }
  
  /* Carousel 模式的平滑过渡 */
  slideshow-slide.variant-filtered {
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
    position: absolute !important;
    left: -9999px !important;
  }
  
  /* Zoom 对话框中的过滤 */
  .dialog-zoomed-gallery > li.variant-filtered {
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
    position: absolute !important;
    left: -9999px !important;
  }
  
  /* Ensure variant-filtered items don't get gallery layout classes */
  .product-media-container.variant-filtered.gallery-first-large,
  .product-media-container.variant-filtered.gallery-thumbnail {
    grid-column: auto !important;
  }
  
  /* Grid 布局在不同屏幕下的基础样式 - 由媒体查询覆盖 */
  
  /* 移动端布局在前面已经通过绝对定位方式重新定义 */
  
  /* 桌面端布局系统 - 基于固定类名，不依赖DOM位置 */
  @media screen and (min-width: 750px) {
    /* Grid布局 - 两列，使用 display flow */
    .media-gallery--two-column .media-gallery__grid {
      display: grid !important;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--image-gap, 0px);
    }
    
    /* 第一张大图 - 占满一行（两列） */
    .media-gallery--two-column .media-gallery__grid .product-media-container.gallery-first-large:not(.variant-filtered) {
      grid-column: span 2 !important;
      position: relative !important;
    }
    
    /* 缩略图 - 一行两个（单列） */
    .media-gallery--two-column .media-gallery__grid .product-media-container.gallery-thumbnail:not(.variant-filtered) {
      grid-column: span 1 !important;
      position: relative !important;
    }
    
    /* One column layout */
    .media-gallery--one-column .media-gallery__grid {
      display: grid !important;
      grid-template-columns: 1fr !important;
      gap: var(--image-gap, 0px);
    }
    
    .media-gallery--one-column .media-gallery__grid .product-media-container:not(.variant-filtered) {
      grid-column: span 1 !important;
      position: relative !important;
    }
  }
  
  
  /* Disable scrolling on zoom dialog */
  zoom-dialog dialog {
    overflow: hidden !important;
    overscroll-behavior: none !important;
    touch-action: none !important;
    background: transparent !important;
    backdrop-filter: none;
  }
  

  @media screen and (max-width: 1300px) {
    .dialog-zoomed-gallery .product-media-container .dialog-zoomed-gallery__close-button {
      left: 91% ;
    }
    .dialog-zoomed-gallery > li .zoom-dialog-counter {
      position: absolute !important;
      bottom: 20px !important;
      left: 90%;
  
    }

  }
  @media screen and (max-width: 1200px) {
    .dialog-zoomed-gallery .product-media-container .dialog-zoomed-gallery__close-button {
      left: 91% ;
    }
    .dialog-zoomed-gallery > li .zoom-dialog-counter {
      position: absolute ;
      bottom: 20px ;
      left: 89% ;
  
    }

  }
  @media screen and (max-width: 1024px) {
    .dialog-zoomed-gallery .product-media-container .dialog-zoomed-gallery__close-button {
      left: 91%;
    }
    .dialog-zoomed-gallery > li .zoom-dialog-counter {
      position: absolute ;
      bottom: 20px;
      left: 87%;
  
    }

  }

  /* Hide thumbnail list in zoom dialog on mobile */
  @media screen and (max-width: 749px) {
    zoom-dialog .dialog-thumbnails-list-container {
      display: none !important;
    }
  }

  .dialog-zoomed-gallery {
    cursor: zoom-out;
    overflow: hidden !important;
    overscroll-behavior: none !important;
    touch-action: none !important;
  }

  .dialog--preloading {
    opacity: 0;
  }
  
  /* Ensure dialog opens instantly without animation */
  zoom-dialog dialog {
    animation: none !important;
    transition: none !important;
  }
  
  zoom-dialog dialog[open] {
    opacity: 1 !important;
    transition: none !important;
  }
  
  zoom-dialog dialog::backdrop {
    animation: none !important;
    transition: none !important;
    background: rgba(0, 0, 0, 0.8) !important;
  }
  
  /* Disable view-transition animations for zoom dialog */
  ::view-transition-group(gallery-item) {
    animation-duration: 0.001ms !important;
  }
  
  ::view-transition-old(gallery-item),
  ::view-transition-new(gallery-item) {
    animation-duration: 0.001ms !important;
    animation-name: none !important;
  }
  
  /* Force zoom dialog to open instantly at correct position */
  zoom-dialog .dialog-zoomed-gallery > li,
  zoom-dialog .dialog-zoomed-gallery .product-media-container {
    animation: none !important;
    transition: opacity 0s !important;
  }

  /* Navigation arrows - Desktop styles */
  .zoom-dialog-nav {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    width: 56px;
    height: 56px;
    background: rgba(255, 255, 255, 0.95);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    z-index: 1001;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
  }

  .zoom-dialog-nav:hover {
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    transform: translateY(-50%) scale(1.08);
  }

  .zoom-dialog-nav svg {
    color: #333;
    width: 28px;
    height: 28px;
  }

  .zoom-dialog-nav--prev {
    left: 40px;
  }

  .zoom-dialog-nav--next {
    right: 40px;
  }

  /* Image counter - Desktop: positioned relative to li container (below image) */
  @media screen and (min-width: 750px) {
    /* 计数器相对于 li 容器定位，显示在图片下方 */
    .dialog-zoomed-gallery > li .zoom-dialog-counter {
      position: absolute !important;
      bottom: 20px !important;
      left: 92% !important;

      color: #fff;
      font-size: 12px;
      font-weight: 500;
   
    }

    .dialog-zoomed-gallery > li .zoom-dialog-counter__current {
      font-weight: 600;
    }

    .dialog-zoomed-gallery > li .zoom-dialog-counter__separator {
      margin: 0 6px;
      opacity: 0.9;
    }
  }
  
  /* Mobile: 旧的固定定位计数器样式（已被下面的新样式替换） */
  /* 移动端计数器现在相对于 product-media-container 定位，显示在图片下方外面 */

  /* Mobile styles */
  @media screen and (max-width: 749px) {
    .zoom-dialog-nav {
      width: 44px;
      height: 44px;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      border: none !important;
      outline: none !important;
    }
    
    .zoom-dialog-nav:focus {
      outline: none !important;
      border: none !important;
    }
    
    .zoom-dialog-nav svg {
      width: 20px;
      height: 20px;
    }

    .zoom-dialog-nav--prev {
      left: 24px;
    }

    .zoom-dialog-nav--next {
      right: 24px;
    }
    
    .zoom-dialog-nav:active {
      transform: translateY(-50%) scale(0.95);
    }

    /* 移动端：计数器相对于 product-media-container 定位（图片下方外面） */
    .dialog-zoomed-gallery .product-media-container .zoom-dialog-counter {
      position: absolute !important;
      bottom: 21% !important;
      left: 85% !important;
      transform: translateX(-50%) !important;
      font-size: 12px;
      color: #fff;

    }
    
    .dialog-zoomed-gallery .product-media-container .zoom-dialog-counter__separator {
      margin: 0 6px;
      opacity: 0.9;
    }
    
    .dialog-zoomed-gallery .product-media-container .zoom-dialog-counter__current {
      font-weight: 600;
    }
  }

  .product-media__drag-zoom-wrapper {
    aspect-ratio: inherit;
    min-height: inherit;
    min-width: inherit;
    display: inherit;
    flex: inherit;
  }

  /* Desktop zoom dialog */
  @media screen and (min-width: 750px) {
    zoom-dialog dialog {
      overflow: hidden !important;
      overscroll-behavior: none !important;
      touch-action: none !important;
    }

    .dialog-zoomed-gallery {
      overflow: hidden !important;
      overscroll-behavior: none !important;
      display: block !important;
      position: relative !important;
      width: 100% !important;
      height: 100% !important;
    }

    .dialog-zoomed-gallery > li {
      position: absolute !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      /* 让容器自适应内容大小 */
      width: auto !important;
      height: auto !important;
      max-width: 90vw;
      max-height: 85vh;
      overflow: visible !important; /* 确保外层的按钮和计数器可见 */
      padding: 20px 20px 50px 20px; /* 为外层元素留出空间 */
    }

    .dialog-zoomed-gallery > li.zoom-active {
      opacity: 1;
      pointer-events: auto;
      /* Keep position absolute but it still acts as positioning context for absolute children */
    }
    
    /* Remove transition for initial load */
    dialog[open] .dialog-zoomed-gallery > li.zoom-active {
      transition: none;
      width: unset;
    }

    .dialog-zoomed-gallery .product-media {
      position: relative;
      box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.6), 
                  0 8px 32px rgba(0, 0, 0, 0.7),
                  0 20px 60px rgba(0, 0, 0, 0.6),
                  0 40px 100px rgba(0, 0, 0, 0.5);
      border-radius: 4px;
      overflow: visible; /* 保持阴影效果可见 */
    }
    
    /* Make drag-zoom-wrapper relative for button positioning */
    .dialog-zoomed-gallery .product-media__drag-zoom-wrapper {
      position: relative;
      overflow: hidden;
      border-radius: 4px;
    }

    .dialog-zoomed-gallery .product-media__image {
      max-width: 100%;
      max-height: 75vh; /* 减小高度为外层元素留出空间 */
      width: auto !important;
      height: auto !important;
      object-fit: contain;
      margin: 0 auto;
      display: block;
    }

    .dialog-zoomed-gallery .product-media__drag-zoom-wrapper .product-media__image {
      max-width: 100%;
      max-height: 75vh;
    }
  }




  @media screen and (max-width: 749px) {
    zoom-dialog dialog {
      overflow: hidden !important;
      overscroll-behavior: none !important;
      touch-action: none !important;
      position: fixed !important;
      padding: 0 !important;
    }

    .dialog-zoomed-gallery {
      /* Completely disable all scrolling and touch navigation */
      overscroll-behavior: none !important;
      scrollbar-width: none !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      /* scroll-snap-type: x mandatory; */ /* Disabled to prevent swipe navigation */
      overflow: hidden !important;
      overflow-x: hidden !important;
      overflow-y: hidden !important;
      /* scroll-behavior: smooth; */ /* Disabled to prevent scroll navigation */
      height: 100% !important;
      width: 100% !important;
      touch-action: none !important;
      position: relative !important;

      &::-webkit-scrollbar {
        display: none !important;
      }
    }

    .dialog-zoomed-gallery .product-media-container {
      /* flex: 0 0 100%; */ /* Disabled for non-swipe layout */
      /* scroll-snap-align: start; */ /* Disabled to prevent snap scrolling */
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      transform: none !important;
      width: 100% !important;
      height: 100% !important;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      overflow: visible !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      /* 为外层的关闭按钮和计数器留出空间 */
      padding: 60px 20px 80px 20px !important;
      box-sizing: border-box !important;
    }
    
    /* Show only the active image */
    .dialog-zoomed-gallery .product-media-container.zoom-active {
      opacity: 1;
      pointer-events: auto;
    }
    
    /* Remove transition for initial load */
    dialog[open] .dialog-zoomed-gallery .product-media-container.zoom-active {
      transition: none;
    }
    
    /* Image wrapper with relative positioning for absolute buttons */
    .dialog-zoomed-gallery .product-media {
      position: relative;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6), 0 4px 16px rgba(0, 0, 0, 0.4);
      border-radius: 8px;
      overflow: visible !important;
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
    }
    
    .dialog-zoomed-gallery .product-media-container--image .product-media {
      overflow: visible !important;
      img{
        background: transparent;
      }
    }

    
    
    .dialog-zoomed-gallery .product-media__image {
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: calc(100vh - 180px); /* 为外层按钮和计数器留空间 */
      object-fit: contain;
      display: block;
      border-radius: 8px;
    }

    .dialog-zoomed-gallery .product-media-container--video,
    .dialog-zoomed-gallery .product-media-container--external_video {
      align-content: center;
    }

    .dialog-zoomed-gallery
      :is(.product-media-container--video, .product-media-container--external_video, .product-media-container--model)
      .product-media {
      aspect-ratio: auto;
      align-items: center;
      height: 100%;

      .product-media__image {
        height: 100%;
      }
    }

    .product-media__drag-zoom-wrapper {
      display: flex;
      aspect-ratio: auto;
      max-height: 100%;
      width: 100%;
      max-width: 100%;
      overflow: scroll;
      scrollbar-width: none;
      justify-content: center;
      align-items: center;
      border-radius: 8px;

      &::-webkit-scrollbar {
        display: none;
      }
    }

    .product-media__drag-zoom-wrapper .product-media__image {
      --product-media-fit: contain;

      object-fit: var(--product-media-fit);
      max-height: calc(100vh - 180px); /* 为外层按钮和计数器留空间 */
      width: auto;
      height: auto;
      border-radius: 8px;
      transform: scale(var(--drag-zoom-scale))
        translate(var(--drag-zoom-translate-x, 0), var(--drag-zoom-translate-y, 0));
    }

    .media-gallery--hint {
      --slideshow-gap: var(--gap-2xs);

      :not(.dialog-zoomed-gallery) > .product-media-container:not(:only-child) {
        width: 90%;

        .product-media img {
          object-fit: cover;
        }
      }
    }
  }

  /* Desktop: Close button positioned relative to li container (outside image) */
  @media screen and (min-width: 750px) {
    /* 关闭按钮相对于 li 容器定位，显示在图片外面 */
    .dialog-zoomed-gallery > li .dialog-zoomed-gallery__close-button {
      position: absolute !important;
      top: -18px !important;
      right: 15px !important;
      color: #fff;
      z-index: 10000 !important;
      width: 36px;
      height: 36px;
      display: flex !important;
      align-items: center;
      justify-content: center;
      pointer-events: auto !important;
      cursor: pointer !important;
      border: none !important;
      outline: none !important;
      touch-action: auto !important;
      transition: all 0.2s ease;
    }
    
  
    
    .dialog-zoomed-gallery > li .dialog-zoomed-gallery__close-button:active {
      transform: scale(0.95);
      background: rgba(0, 0, 0, 1);
    }
    
    .dialog-zoomed-gallery > li .dialog-zoomed-gallery__close-button svg {
      width: 20px;
      height: 20px;
      pointer-events: none !important;
      color: #fff;
      opacity: 1;
    }
    
    .dialog-zoomed-gallery > li .dialog-zoomed-gallery__close-button * {
      pointer-events: none !important;
    }
  }
  


  @media screen and (max-width: 749px) {
    /* 移动端：关闭按钮相对于 product-media-container 定位（图片外面） */
    .dialog-zoomed-gallery .product-media-container .dialog-zoomed-gallery__close-button {
      position: absolute !important;
      top: 16% !important;
      right: 15px !important;
      left:88% !important;
      width: 36px !important;
      height: 36px !important;
      z-index: 10000 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      pointer-events: auto !important;
      cursor: pointer !important;

    }
    
 
    .dialog-zoomed-gallery .product-media-container .dialog-zoomed-gallery__close-button svg {
      width: 20px !important;
      height: 20px !important;
      color: #fff !important;
      opacity: 1 !important;
      pointer-events: none !important;
    }
    
    slideshow-controls.desktop\:hidden.media-gallery__mobile-controls {
      display: none;
    }
  }

  .media-gallery__mobile-controls {
    grid-area: auto;
  }

  .dialog-zoomed-gallery .product-media-container--zoomable.product-media-container--image {
    cursor: zoom-out;
  }

  .product-media-container--zoomable.product-media-container--image {
    cursor: zoom-in;
  }

  .dialog-zoomed-gallery .product-media-container--video deferred-media,
  .dialog-zoomed-gallery .product-media-container--external_video deferred-media {
    height: auto;
    aspect-ratio: var(--ratio);
  }

  .dialog-zoomed-gallery .product-media-container--model .product-media__image {
    /* Make the height match the height of the model-viewer */
    height: 100vh;
  }

  /* Special styles for first zoomed image - add custom styles as needed */

  /* Mobile Grid Navigation Arrows */
  .mobile-grid-nav {
    display: none;
  }

  @media screen and (max-width: 749px) {
    .media-gallery--grid .mobile-grid-nav {
      display: none;
      position: relative;
      width: 100%;
      height: 0;
      pointer-events: none;
    }

    .mobile-grid-nav__button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 10;
      pointer-events: auto;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mobile-grid-nav__button:active {
      transform: translateY(-50%) scale(0.9);
      background: rgba(255, 255, 255, 1);
    }

    .mobile-grid-nav__button svg {
      width: 20px;
      height: 20px;
      color: #333;
    }

    .mobile-grid-nav__button--prev {
      left: 12px;
    }

    .mobile-grid-nav__button--next {
      right: 12px;
    }

    .mobile-grid-nav__button:disabled {
      opacity: 0.3;
      pointer-events: none;
    }
  }

  /* Mobile thumbnail navigation */
  .mobile-thumbnail-nav {
    display: none;
  }

  @media screen and (max-width: 749px) {
    .mobile-thumbnail-nav {
      display: block !important;
      width: 100% !important;
      max-width: 100vw !important;
      padding: 12px 0 !important;
      background: var(--color-background);
      position: relative;
      overflow: hidden !important; /* 严格防止溢出 */
      margin: 12px 0 0 0 !important;
    }

    .mobile-thumbnail-nav__container {
      display: flex !important;
      flex-wrap: nowrap !important; /* 严格禁止换行 */
      flex-direction: row !important; /* 强制水平排列 */
      align-items: flex-start !important;
      gap: 12px !important;
      overflow-x: scroll !important; /* 强制水平滚动 */
      overflow-y: hidden !important; /* 严格禁止垂直滚动 */
      padding: 0 16px !important;
      scroll-behavior: smooth;
      scrollbar-width: none !important;
      -webkit-overflow-scrolling: touch;
      /* 严格防止滚动时影响页面 */
      overscroll-behavior-x: contain !important;
      overscroll-behavior-y: none !important;
      overscroll-behavior: contain none !important;
      touch-action: pan-x !important; /* 只允许水平滑动 */
      max-width: 100vw !important;
      min-height: 80px !important;
      max-height: 80px !important;
      height: 80px !important; /* 固定高度，防止多行 */
      box-sizing: content-box !important;
      position: relative !important;
      isolation: isolate !important; /* 创建新的层叠上下文 */
    }

    .mobile-thumbnail-nav__container::-webkit-scrollbar {
      display: none !important;
      height: 0 !important;
    }

    .mobile-thumbnail-nav__item {
      flex: 0 0 80px !important; /* 固定宽度，绝不缩放 */
      flex-shrink: 0 !important; /* 绝不收缩 */
      flex-grow: 0 !important; /* 绝不放大 */
      min-width: 80px !important;
      max-width: 80px !important;
      width: 80px !important;
      min-height: 80px !important;
      max-height: 80px !important;
      height: 80px !important;
      padding: 0 !important;
      margin: 0 !important;
      border: 2px solid transparent;
      border-radius: 8px;
      overflow: hidden;
      background: none;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      display: inline-block !important; /* 强制inline-block */
      vertical-align: top;
    }

    .mobile-thumbnail-nav__item::after {
      content: '';
      position: absolute;
      inset: 0;
      border: 2px solid transparent;
      border-radius: 6px;
      transition: border-color 0.3s ease;
      pointer-events: none;
    }

    .mobile-thumbnail-nav__item.active::after {
      border-color: var(--color-foreground, #000);
    }

    .mobile-thumbnail-nav__item img {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
      display: block;
      pointer-events: none !important; /* 防止图片拖拽 */
      user-select: none !important;
      -webkit-user-drag: none !important;
      -webkit-touch-callout: none !important;
    }

    .mobile-thumbnail-nav__item:active {
      transform: scale(0.95);
    }
    
    /* 隐藏被过滤的缩略图 */
    .mobile-thumbnail-nav__item.thumbnail-hidden {
      display: none !important;
    }
  }
{% endstylesheet %}

<script>
  (function() {
    'use strict';

    let currentActiveIndex = 0;
    let currentSlideshowIndex = 0;

    function matchesVariant(mediaAlt, variantString) {
      if (!variantString) {
        return mediaAlt && mediaAlt.trim() !== '';
      }
      if (!mediaAlt || mediaAlt.trim() === '') {
        return false;
      }
      return mediaAlt.trim() === variantString.trim();
    }

    function filterZoomDialogImages(selectedVariantString) {
      const zoomDialog = document.querySelector('#zoom-dialog-{{ block.id }}');
      if (!zoomDialog) return;

      const zoomImages = Array.from(zoomDialog.querySelectorAll('.dialog-zoomed-gallery > li[data-media-alt]'));
      if (zoomImages.length === 0) return;

      let visibleCount = 0;

      // 只通过 class 控制，不操作 style 属性
      zoomImages.forEach(li => {
        const mediaAlt = li.getAttribute('data-media-alt') || '';
        const matches = matchesVariant(mediaAlt, selectedVariantString);

        if (matches) {
          li.classList.remove('variant-filtered');
          visibleCount++;
        } else {
          li.classList.add('variant-filtered');
        }
      });

      // 如果没有匹配的图片，显示所有图片
      if (visibleCount === 0) {
        zoomImages.forEach(li => {
          li.classList.remove('variant-filtered');
        });
        visibleCount = zoomImages.length;
      }

      const counterTotal = zoomDialog.querySelector('.zoom-dialog-counter__total');
      if (counterTotal) {
        counterTotal.textContent = visibleCount;
      }
    }

    function initVariantImageFiltering() {
      const mediaGallery = document.querySelector('media-gallery[data-presentation="{{ block_settings.media_presentation }}"]');
      if (!mediaGallery) return;

      const presentation = mediaGallery.getAttribute('data-presentation');
      const variantForm = document.querySelector('.variant-picker__form');
      if (!variantForm) return;

      function getSelectedVariantValues() {
        const checkedInputs = Array.from(variantForm.querySelectorAll('input[type="radio"]:checked'));
        const values = checkedInputs.map(input => input.value.trim().replace(/\s+/g, '_'));
        return values.join('_');
      }

      function filterImagesByVariant() {
        const selectedVariantString = getSelectedVariantValues();
        filterZoomDialogImages(selectedVariantString);

        if (presentation === 'grid') {
          const gridContainers = Array.from(mediaGallery.querySelectorAll('.media-gallery__grid .product-media-container'));
          let firstMatchIndex = -1;
          let currentIndex = -1;
          let hasChanges = false; // 跟踪是否有实际变化

          // 找到当前显示的图片索引
          gridContainers.forEach((container, index) => {
            if (container.classList.contains('mobile-current')) {
              currentIndex = index;
            }
          });

          // 如果没有找到当前索引，使用第一个可见的
          if (currentIndex === -1) {
            currentIndex = gridContainers.findIndex(c => !c.classList.contains('variant-filtered'));
          }

          // 第一步：检查并更新过滤状态（只通过 class 控制，不操作 display）
          gridContainers.forEach((container, index) => {
            const mediaAlt = container.getAttribute('data-media-alt') || '';
            const matches = matchesVariant(mediaAlt, selectedVariantString);
            const isCurrentlyFiltered = container.classList.contains('variant-filtered');

            if (matches) {
              if (isCurrentlyFiltered) {
                hasChanges = true;
                container.classList.remove('variant-filtered');
                // 不再操作 display 和 hidden，让 CSS 处理
              }
              if (firstMatchIndex === -1) firstMatchIndex = index;
            } else {
              if (!isCurrentlyFiltered) {
                hasChanges = true;
                container.classList.add('variant-filtered');
                // 不再操作 display 和 hidden，让 CSS 处理
              }
            }
          });

          // 如果没有变化，直接返回，避免不必要的DOM操作
          if (!hasChanges) {
            return;
          }

          // 第二步：立即批量更新布局类（不使用 requestAnimationFrame，减少延迟）
          // 更新布局类 - 第一张可见图片用大图布局，其他用缩略图布局
          let visibleCount = 0;
          let layoutChanges = [];
          
          gridContainers.forEach((container, index) => {
            const shouldBeFirstLarge = !container.classList.contains('variant-filtered') && visibleCount === 0;
            const shouldBeThumbnail = !container.classList.contains('variant-filtered') && visibleCount > 0;
            
            const hasFirstLarge = container.classList.contains('gallery-first-large');
            const hasThumbnail = container.classList.contains('gallery-thumbnail');
            
            if (shouldBeFirstLarge !== hasFirstLarge || shouldBeThumbnail !== hasThumbnail) {
              layoutChanges.push({ container, shouldBeFirstLarge, shouldBeThumbnail });
            }
            
            if (!container.classList.contains('variant-filtered')) {
              visibleCount++;
            }
          });
          
          // 批量应用布局变化
          layoutChanges.forEach(({ container, shouldBeFirstLarge, shouldBeThumbnail }) => {
            container.classList.remove('gallery-first-large', 'gallery-thumbnail');
            if (shouldBeFirstLarge) {
              container.classList.add('gallery-first-large');
            } else if (shouldBeThumbnail) {
              container.classList.add('gallery-thumbnail');
            }
          });

          // 第三步：更新移动端当前图片（只在必要时）
          if (window.innerWidth <= 749 && firstMatchIndex >= 0) {
            // 检查当前索引的图片是否仍然可见
            const currentStillVisible = currentIndex >= 0 && 
                                       !gridContainers[currentIndex].classList.contains('variant-filtered');
            
            // 如果当前图片仍可见，保持位置；否则跳转到第一张
            const targetIndex = currentStillVisible ? currentIndex : firstMatchIndex;
            
            // 只在索引真正改变时更新
            if (window._currentGridImageIndex !== targetIndex) {
              window._currentGridImageIndex = targetIndex;

              gridContainers.forEach((container, index) => {
                const shouldBeCurrent = !container.classList.contains('variant-filtered') && index === targetIndex;
                container.classList.toggle('mobile-current', shouldBeCurrent);
              });

              const mobileThumbnails = Array.from(document.querySelectorAll('.mobile-thumbnail-nav__item'));
              mobileThumbnails.forEach((thumb, index) => {
                thumb.classList.toggle('active', index === targetIndex);
                if (index === targetIndex) {
                  thumb.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'center' });
                }
              });
            }
          }

          // 第四步：更新缩略图显示（根据 data-media-alt 过滤）
          const mobileThumbnails = Array.from(document.querySelectorAll('.mobile-thumbnail-nav__item'));
          mobileThumbnails.forEach((thumb, index) => {
            const thumbAlt = thumb.getAttribute('data-media-alt') || '';
            const thumbAltClean = thumbAlt.trim().replace(/\s+/g, '_');
            const matches = matchesVariant(thumbAltClean, selectedVariantString);
            thumb.classList.toggle('thumbnail-hidden', !matches && thumbAltClean !== '');
          });
        } else {
          const slideshow = mediaGallery.querySelector('slideshow-component, [ref="slideshow"]');
          if (!slideshow) return;

          const slides = Array.from(slideshow.querySelectorAll('[data-media-alt]'));
          let firstMatchIndex = -1;
          let currentSlideIndex = currentSlideshowIndex;
          let hasChanges = false;

          // 检查并更新过滤状态（只通过 class 控制，不操作 display）
          slides.forEach((slide, index) => {
            const mediaAlt = slide.getAttribute('data-media-alt') || '';
            const matches = matchesVariant(mediaAlt, selectedVariantString);
            const isCurrentlyFiltered = slide.classList.contains('variant-filtered');

            if (matches) {
              if (isCurrentlyFiltered) {
                hasChanges = true;
                slide.classList.remove('variant-filtered');
                // 不再操作 display 和 hidden，让 CSS 处理
              }
              if (firstMatchIndex === -1) firstMatchIndex = index;
            } else {
              if (!isCurrentlyFiltered) {
                hasChanges = true;
                slide.classList.add('variant-filtered');
                // 不再操作 display 和 hidden，让 CSS 处理
              }
            }
          });

          // 如果没有变化，直接返回
          if (!hasChanges) {
            return;
          }

          // 立即处理幻灯片切换（不使用 requestAnimationFrame）
          // 检查当前幻灯片是否仍然可见
          const currentStillVisible = currentSlideIndex >= 0 && 
                                     currentSlideIndex < slides.length &&
                                     !slides[currentSlideIndex].classList.contains('variant-filtered');
          
          // 如果当前幻灯片仍可见，保持位置；否则跳转到第一张
          if (!currentStillVisible && firstMatchIndex >= 0 && typeof slideshow.select === 'function') {
            slideshow.select(firstMatchIndex, null, { animate: false });
            currentSlideshowIndex = firstMatchIndex;
          }
        }
      }

      let lastVariantString = '';
      let isProcessing = false;

      document.addEventListener('variant:update', () => {
        // 使用 requestAnimationFrame 实现零延迟响应
        if (isProcessing) return;
        isProcessing = true;
        
        requestAnimationFrame(() => {
          const currentVariantString = getSelectedVariantValues();
          // 只在 variant 真正改变时才执行过滤
          if (currentVariantString !== lastVariantString) {
            lastVariantString = currentVariantString;
            filterImagesByVariant();
          }
          isProcessing = false;
        });
      });

      // 立即执行初始过滤，无延迟
      const initialVariantString = getSelectedVariantValues();
      lastVariantString = initialVariantString;
      filterImagesByVariant();

      // 过滤后设置布局类和移动端初始显示
      const gridContainers = Array.from(document.querySelectorAll('.media-gallery__grid .product-media-container'));
      let visibleCount = 0;
      let firstVisibleIndex = -1;
      
      gridContainers.forEach((container, index) => {
        if (!container.classList.contains('variant-filtered')) {
          if (visibleCount === 0) {
            container.classList.add('gallery-first-large');
            firstVisibleIndex = index;
            // 移动端：设置第一张可见图片为当前显示
            if (window.innerWidth <= 749) {
              container.classList.add('mobile-current');
              window._currentGridImageIndex = index;
            }
          } else {
            container.classList.add('gallery-thumbnail');
          }
          visibleCount++;
        }
      });
    }

    function initMobileThumbnails() {
      const mediaGallery = document.querySelector('media-gallery[data-presentation="{{ block_settings.media_presentation }}"]');
      if (!mediaGallery) return;

      const presentation = mediaGallery.getAttribute('data-presentation');
      const slideshow = mediaGallery.querySelector('slideshow-component, [ref="slideshow"]');
      const mobileThumbnails = Array.from(document.querySelectorAll('.mobile-thumbnail-nav__item'));
      const gridContainers = Array.from(mediaGallery.querySelectorAll('.media-gallery__grid .product-media-container'));

      if (mobileThumbnails.length === 0) return;

      if (presentation === 'grid' && gridContainers.length > 0) {
        const totalImages = mobileThumbnails.length;
        
        // 使用已经设置的全局索引，或找到第一张可见图片
        let currentMobileIndex = window._currentGridImageIndex || 0;
        
        // 如果当前索引的图片被过滤了，找到第一张可见的
        if (gridContainers[currentMobileIndex]?.classList.contains('variant-filtered')) {
          currentMobileIndex = gridContainers.findIndex(c => !c.classList.contains('variant-filtered'));
          if (currentMobileIndex === -1) currentMobileIndex = 0;
          window._currentGridImageIndex = currentMobileIndex;
        }

        const prevBtn = mediaGallery.querySelector('.mobile-grid-nav__button--prev');
        const nextBtn = mediaGallery.querySelector('.mobile-grid-nav__button--next');

        function switchMobileImage(newIndex) {
          if (newIndex < 0 || newIndex >= totalImages) return;
          
          // 如果这个图片被过滤了，不要切换
          if (gridContainers[newIndex]?.classList.contains('variant-filtered')) {
            return;
          }

          currentMobileIndex = newIndex;
          // 同步到全局 grid 索引，用于 zoom 对话框
          window._currentGridImageIndex = newIndex;

          gridContainers.forEach((container, i) => {
            container.classList.toggle('mobile-current', i === newIndex && !container.classList.contains('variant-filtered'));
          });

          mobileThumbnails.forEach((t, i) => {
            t.classList.toggle('active', i === newIndex);
          });

          if (mobileThumbnails[newIndex]) {
            mobileThumbnails[newIndex].scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'center' });
          }

          if (prevBtn) prevBtn.disabled = (newIndex === 0);
          if (nextBtn) nextBtn.disabled = (newIndex === totalImages - 1);
        }

        mobileThumbnails.forEach((thumbnail, index) => {
          thumbnail.addEventListener('click', e => {
            e.preventDefault();
            // 如果缩略图被隐藏（被过滤），不执行操作
            if (thumbnail.classList.contains('thumbnail-hidden')) {
              return;
            }
            switchMobileImage(index);
          });
        });

        if (prevBtn) {
          prevBtn.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();
            if (currentMobileIndex > 0) switchMobileImage(currentMobileIndex - 1);
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();
            if (currentMobileIndex < totalImages - 1) switchMobileImage(currentMobileIndex + 1);
          });
        }

        // 初始化缩略图的激活状态
        mobileThumbnails.forEach((thumb, i) => {
          const isHidden = thumb.classList.contains('thumbnail-hidden');
          thumb.classList.toggle('active', i === currentMobileIndex && !isHidden);
        });

        // 使用已经设置好的索引（第一张可见图片）
        switchMobileImage(currentMobileIndex);

        const thumbnailNav = document.querySelector('.mobile-thumbnail-nav');

        if (thumbnailNav) {
          let startX = 0;
          let startY = 0;
          let isHorizontalScroll = false;

          thumbnailNav.addEventListener('touchstart', e => {
            const touch = e.touches[0];
            startX = touch.clientX;
            startY = touch.clientY;
            isHorizontalScroll = false;
          }, { passive: true });

          thumbnailNav.addEventListener('touchmove', e => {
            const touch = e.touches[0];
            const deltaX = Math.abs(touch.clientX - startX);
            const deltaY = Math.abs(touch.clientY - startY);

            if (!isHorizontalScroll && (deltaX > 5 || deltaY > 5)) {
              isHorizontalScroll = deltaX > deltaY;
            }

            if (isHorizontalScroll) {
              e.preventDefault();
            }
          }, { passive: false });

          thumbnailNav.addEventListener('touchend', e => {
            isHorizontalScroll = false;
          }, { passive: true });

          thumbnailNav.addEventListener('wheel', e => {
            e.stopPropagation();
          }, { passive: true });
        }

        return;
      }

      if (!slideshow) return;

      mobileThumbnails.forEach((thumbnail, index) => {
        thumbnail.addEventListener('click', e => {
          e.preventDefault();
          currentSlideshowIndex = index;
          mobileThumbnails.forEach(t => t.classList.remove('active'));
          thumbnail.classList.add('active');
          if (typeof slideshow.select === 'function') {
            slideshow.select(index, e, { animate: true });
          }
          thumbnail.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        });
      });

      slideshow.addEventListener('slideshow:select', e => {
        const index = e.detail?.index;
        if (index === undefined) return;
        currentSlideshowIndex = index;
        if (mobileThumbnails[index]) {
          mobileThumbnails.forEach(t => t.classList.remove('active'));
          mobileThumbnails[index].classList.add('active');
          mobileThumbnails[index].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
      });
    }

    function initZoomButtonIntercept() {
      const mediaGallery = document.querySelector('media-gallery[data-presentation="{{ block_settings.media_presentation }}"]');
      if (!mediaGallery) return;

      const presentation = mediaGallery.getAttribute('data-presentation');
      const zoomDialog = document.querySelector('#zoom-dialog-{{ block.id }}');
      if (!zoomDialog) return;

      function findMediaIndex(element) {
        let current = element;
        let depth = 0;
        while (current && depth < 10) {
          if (current.hasAttribute('data-media-index')) {
            return parseInt(current.getAttribute('data-media-index'), 10);
          }
          current = current.parentElement;
          depth++;
        }
        return null;
      }

      if (presentation === 'grid') {
        const gridContainers = Array.from(mediaGallery.querySelectorAll('.media-gallery__grid .product-media-container--zoomable'));
        
        // 统一的点击处理函数
        const handleContainerClick = (container, index, e) => {
          if (e.target.closest('dialog')) return;
          
          let mediaIndex = findMediaIndex(container);
          if (mediaIndex === null || isNaN(mediaIndex)) mediaIndex = index;
          
          e.preventDefault();
          e.stopPropagation();
          
          // 在移动端 grid 模式下，使用当前显示的图片索引
          if (window.innerWidth <= 749 && typeof window._currentGridImageIndex !== 'undefined') {
            mediaIndex = window._currentGridImageIndex;
          } else {
            // 桌面端：更新全局索引为点击的图片
            window._currentGridImageIndex = mediaIndex;
          }
          
          if (typeof zoomDialog.open === 'function') {
            zoomDialog.open(mediaIndex, e);
          }
        };
        
        gridContainers.forEach((container, index) => {
          // 使用 click 和 touchend 两种事件确保移动端能触发
          container.addEventListener('click', (e) => handleContainerClick(container, index, e), { capture: true, passive: false });
          container.addEventListener('touchend', (e) => {
            // 只在tap（快速点击）时触发zoom，避免滚动时触发
            const touch = e.changedTouches[0];
            const elem = document.elementFromPoint(touch.clientX, touch.clientY);
            if (elem && container.contains(elem)) {
              handleContainerClick(container, index, e);
            }
          }, { capture: true, passive: false });
        });
        return;
      }

      const zoomableContainers = Array.from(mediaGallery.querySelectorAll('.product-media-container--zoomable'));
      zoomableContainers.forEach((container, fallbackIndex) => {
        container.addEventListener('click', e => {
          if (e.target.closest('dialog')) return;
          let mediaIndex = findMediaIndex(container);
          if (mediaIndex === null || isNaN(mediaIndex)) mediaIndex = fallbackIndex;
          e.preventDefault();
          e.stopPropagation();
          currentSlideshowIndex = mediaIndex;
          if (typeof zoomDialog.open === 'function') zoomDialog.open(mediaIndex, e);
        }, true);
      });
    }

    function initZoomGallery() {
      const zoomDialog = document.querySelector('#zoom-dialog-{{ block.id }}');
      if (!zoomDialog) return;

      const dialog = zoomDialog.querySelector('dialog');
      if (!dialog) return;

      const gallery = dialog.querySelector('.dialog-zoomed-gallery');
      const mediaContainers = Array.from(dialog.querySelectorAll('.dialog-zoomed-gallery > li'));
      const thumbnails = Array.from(dialog.querySelectorAll('.dialog-thumbnails-list__thumbnail'));

      let isClosing = false;

      function bindCloseButton() {
        const closeBtn = dialog.querySelector('.dialog-zoomed-gallery__close-button');
        if (closeBtn) {
          closeBtn.removeEventListener('click', handleCloseClick);
          closeBtn.addEventListener('click', handleCloseClick);
        }
      }

      function closeZoomDialog() {
        if (!dialog || !dialog.open) return;

        if (typeof zoomDialog.closeDialog === 'function') {
          zoomDialog.closeDialog();
        } else if (typeof zoomDialog.close === 'function') {
          zoomDialog.close();
        } else {
          dialog.close();
        }

        setTimeout(() => {
          if (dialog.open) dialog.removeAttribute('open');
        }, 50);
      }

      function handleCloseClick(e) {
        e.preventDefault();
        e.stopPropagation();
        closeZoomDialog();
      }

      function moveControlsToContainer() {
        const closeBtn = dialog.querySelector('.dialog-zoomed-gallery__close-button');
        const counter = dialog.querySelector('.zoom-dialog-counter');

        let targetElement = window.innerWidth > 749 
          ? dialog.querySelector('.dialog-zoomed-gallery > li.zoom-active') 
          : dialog.querySelector('.product-media-container.zoom-active');

        if (closeBtn && counter && targetElement) {
          if (!targetElement.contains(closeBtn)) {
            targetElement.appendChild(closeBtn);
            bindCloseButton();
          }
          if (!targetElement.contains(counter)) {
            targetElement.appendChild(counter);
          }
        }
      }

      const firstMediaImage = dialog.querySelector('.dialog-zoomed-gallery li:first-child .product-media__image');
      if (firstMediaImage) firstMediaImage.classList.add('product-media__image--first-zoom');

      bindCloseButton();
      moveControlsToContainer();

      const prevBtn = document.getElementById('zoom-prev-{{ block.id }}');
      const nextBtn = document.getElementById('zoom-next-{{ block.id }}');
      const counterElement = document.getElementById('zoom-counter-{{ block.id }}');
      const counterCurrent = counterElement ? counterElement.querySelector('.zoom-dialog-counter__current') : null;

      function updateNavButtons() {
        if (prevBtn) prevBtn.disabled = false;
        if (nextBtn) nextBtn.disabled = false;
      }

      function updateCounter() {
        if (!counterCurrent) return;

        const visibleImages = mediaContainers.map((_, idx) => idx).filter(idx => !mediaContainers[idx].classList.contains('variant-filtered'));

        const currentPosition = visibleImages.indexOf(currentActiveIndex) + 1 || 1;
        counterCurrent.textContent = currentPosition;

        const counterTotal = counterElement.querySelector('.zoom-dialog-counter__total');
        if (counterTotal) counterTotal.textContent = visibleImages.length;
      }

      function switchToImage(index) {
        if (index < 0 || index >= mediaContainers.length) return;

        let targetIndex = index;
        let attempts = 0;
        while (mediaContainers[targetIndex].classList.contains('variant-filtered') && attempts < mediaContainers.length) {
          targetIndex = (targetIndex + 1) % mediaContainers.length;
          attempts++;
        }

        if (attempts >= mediaContainers.length) return;

        mediaContainers.forEach(container => container.classList.remove('zoom-active'));
        mediaContainers[targetIndex].classList.add('zoom-active');
        currentActiveIndex = targetIndex;

        updateNavButtons();
        updateCounter();
        moveControlsToContainer();
        bindCloseButton();
      }

      const originalZoomOpen = zoomDialog.open ? zoomDialog.open.bind(zoomDialog) : null;
      if (originalZoomOpen) {
        zoomDialog.open = function(index, event) {
          if (isClosing) return;
          currentActiveIndex = index;
          originalZoomOpen(index, event);

          setTimeout(() => {
            const selectedVariantString = getSelectedVariantValuesFromForm();
            filterZoomDialogImages(selectedVariantString);

            // 检查点击的图片是否可见
            const clickedImageVisible = currentActiveIndex >= 0 && 
                                       currentActiveIndex < mediaContainers.length &&
                                       !mediaContainers[currentActiveIndex].classList.contains('variant-filtered');

            let targetIndex;
            if (clickedImageVisible) {
              // 如果点击的图片可见，使用点击的索引
              targetIndex = currentActiveIndex;
            } else {
              // 如果点击的图片被过滤了，才使用第一张可见的
              targetIndex = mediaContainers.findIndex(container => !container.classList.contains('variant-filtered'));
            }

            if (targetIndex >= 0) {
              mediaContainers.forEach((container, idx) => container.classList.toggle('zoom-active', idx === targetIndex));
              currentActiveIndex = targetIndex;
              updateCounter();
            }

            moveControlsToContainer();
            bindCloseButton();
          }, 100);
        };
      }

      // Define getSelectedVariantValuesFromForm if not defined elsewhere
      function getSelectedVariantValuesFromForm() {
        const variantForm = document.querySelector('.variant-picker__form');
        if (!variantForm) return '';
        const checkedInputs = Array.from(variantForm.querySelectorAll('input[type="radio"]:checked'));
        const values = checkedInputs.map(input => input.value.trim().replace(/\s+/g, '_'));
        return values.join('_');
      }

      zoomDialog.addEventListener('zoom-media-selected', e => {
        if (e.detail !== undefined) switchToImage(e.detail);
      });

      if (prevBtn) {
        prevBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          let newIndex = currentActiveIndex - 1;
          let attempts = 0;

          while (attempts < mediaContainers.length) {
            if (newIndex < 0) newIndex = mediaContainers.length - 1;
            if (!mediaContainers[newIndex].classList.contains('variant-filtered')) break;
            newIndex--;
            attempts++;
          }

          if (attempts < mediaContainers.length) {
            switchToImage(newIndex);
            thumbnails.forEach((thumb, i) => thumb.setAttribute('aria-selected', i === currentActiveIndex ? 'true' : 'false'));
          }
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();

          let newIndex = currentActiveIndex + 1;
          let attempts = 0;

          while (attempts < mediaContainers.length) {
            if (newIndex >= mediaContainers.length) newIndex = 0;
            if (!mediaContainers[newIndex].classList.contains('variant-filtered')) break;
            newIndex++;
            attempts++;
          }

          if (attempts < mediaContainers.length) {
            switchToImage(newIndex);
            thumbnails.forEach((thumb, i) => thumb.setAttribute('aria-selected', i === currentActiveIndex ? 'true' : 'false'));
          }
        });
      }

      updateNavButtons();
      updateCounter();

      window.addEventListener('resize', moveControlsToContainer);

      dialog.addEventListener('click', e => {
        if (e.target === dialog || e.target.classList.contains('dialog-zoomed-gallery')) {
          isClosing = true;
          e.preventDefault();
          e.stopPropagation();
          if (typeof zoomDialog.close === 'function') {
            zoomDialog.close();
          } else if (dialog.open) {
            dialog.close();
          }
          setTimeout(() => isClosing = false, 300);
        }
      });

      function preventGalleryScroll(e) {
        if (e.target.closest('.dialog-thumbnails-list-container') || e.target.closest('button') || e.target.closest('.product-media__drag-zoom-wrapper')) return;
        e.preventDefault();
      }

      function preventWheel(e) {
        if (e.target.closest('.dialog-thumbnails-list-container')) return;
        e.preventDefault();
      }

      if (gallery) {
        gallery.addEventListener('wheel', preventWheel, { passive: false });
        gallery.addEventListener('touchmove', preventGalleryScroll, { passive: false });
        gallery.scrollLeft = 0;
        gallery.scrollTop = 0;
      }

      thumbnails.forEach((thumbnail, index) => {
        thumbnail.addEventListener('click', () => {
          switchToImage(index);
          thumbnails.forEach((thumb, i) => thumb.setAttribute('aria-selected', i === index ? 'true' : 'false'));
        });
      });

      zoomDialog.addEventListener('zoom-media-selected', e => {
        if (e.detail !== undefined) switchToImage(e.detail);
      });

      dialog.addEventListener('close', () => {
        mediaContainers.forEach(container => container.classList.remove('zoom-active'));
        currentActiveIndex = 0;
        updateNavButtons();
        updateCounter();
        setTimeout(() => isClosing = false, 100);
      });

      window.addEventListener('dialog-close', () => {
        if (!dialog.open) {
          mediaContainers.forEach(container => container.classList.remove('zoom-active'));
          currentActiveIndex = 0;
        }
      });

      dialog.addEventListener('keydown', e => {
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          let newIndex = currentActiveIndex - 1;
          let attempts = 0;
          while (attempts < mediaContainers.length) {
            if (newIndex < 0) newIndex = mediaContainers.length - 1;
            if (!mediaContainers[newIndex].classList.contains('variant-filtered')) break;
            newIndex--;
            attempts++;
          }
          if (attempts < mediaContainers.length) {
            switchToImage(newIndex);
            thumbnails.forEach((thumb, i) => thumb.setAttribute('aria-selected', i === currentActiveIndex ? 'true' : 'false'));
          }
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          let newIndex = currentActiveIndex + 1;
          let attempts = 0;
          while (attempts < mediaContainers.length) {
            if (newIndex >= mediaContainers.length) newIndex = 0;
            if (!mediaContainers[newIndex].classList.contains('variant-filtered')) break;
            newIndex++;
            attempts++;
          }
          if (attempts < mediaContainers.length) {
            switchToImage(newIndex);
            thumbnails.forEach((thumb, i) => thumb.setAttribute('aria-selected', i === currentActiveIndex ? 'true' : 'false'));
          }
        }
      });
    }

    // 预加载所有产品图片，避免切换时闪烁
    function preloadAllImages() {
      const mediaGallery = document.querySelector('media-gallery[data-presentation="{{ block_settings.media_presentation }}"]');
      if (!mediaGallery) return;

      // 获取所有图片元素
      const images = mediaGallery.querySelectorAll('.product-media__image');
      
      // 立即加载所有图片
      images.forEach(img => {
        // 移除懒加载属性
        if (img.hasAttribute('loading')) {
          img.removeAttribute('loading');
        }
        
        // 设置为立即加载
        img.loading = 'eager';
        
        // 提升解码优先级
        if (img.decoding) {
          img.decoding = 'sync';
        }
        
        // 触发图片加载
        if (img.dataset.src && !img.src) {
          img.src = img.dataset.src;
        }
        
        // 如果图片还未加载完成，强制触发加载
        if (!img.complete && img.src) {
          const tempImg = new Image();
          tempImg.src = img.src;
        }
      });
    }

    function initializeAll() {
      // 初始化全局图片索引（如果还未设置）
      if (typeof window._currentGridImageIndex === 'undefined') {
        window._currentGridImageIndex = 0;
      }
      
      // 预加载所有图片
      preloadAllImages();
      
      initVariantImageFiltering();
      initMobileThumbnails();
      initZoomButtonIntercept();
      initZoomGallery();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeAll);
    } else {
      initializeAll();
    }

    // 优化 MutationObserver，立即初始化无延迟
    let isObserverInitialized = false;
    const bodyObserver = new MutationObserver(mutations => {
      let hasMediaGalleryAdded = false;
      
      mutations.forEach(mutation => {
        mutation.addedNodes.forEach(node => {
          if (node.nodeType === 1 && node.tagName === 'MEDIA-GALLERY') {
            hasMediaGalleryAdded = true;
          }
        });
      });
      
      // 只在真正添加了 media-gallery 且未初始化时才初始化
      if (hasMediaGalleryAdded && !isObserverInitialized) {
        isObserverInitialized = true;
        // 立即初始化，无延迟
        initializeAll();
      }
    });

    bodyObserver.observe(document.body, { childList: true, subtree: true });
  })();
</script>
<script>
  // 独立的关闭按钮处理脚本 - 完全隔离，不污染全局作用域
  (function() {
    'use strict';
    
    // 使用唯一的命名空间避免冲突
    const SCRIPT_ID = 'zoom-close-handler-{{ block.id }}';
    
    // 检查是否已经初始化过，避免重复运行
    if (window[SCRIPT_ID]) {
      return;
    }
    
    // 标记已初始化
    window[SCRIPT_ID] = true;
    
    // 私有变量 - 完全封装在闭包中
    let dialogElement = null;
    let zoomDialogElement = null;
    let mutationObserver = null;
    let timers = [];
    
    // 私有函数：清理所有资源
    function cleanup() {
      // 清理定时器
      timers.forEach(function(timer) {
        clearTimeout(timer);
      });
      timers = [];
      
      // 断开观察器
      if (mutationObserver) {
        mutationObserver.disconnect();
        mutationObserver = null;
      }
    }
    
    // 私有函数：关闭处理
    function handleClose(e) {
      // 防止事件冒泡和默认行为
      if (e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
      }
      
      // 尝试多种关闭方法
      try {
        if (zoomDialogElement && typeof zoomDialogElement.close === 'function') {
          zoomDialogElement.close();
          return true;
        }
        
        if (zoomDialogElement && typeof zoomDialogElement.closeDialog === 'function') {
          zoomDialogElement.closeDialog();
          return true;
        }
        
        if (dialogElement && typeof dialogElement.close === 'function') {
          dialogElement.close();
          return true;
        }
      } catch (error) {
        // 静默处理错误，不影响其他脚本
        return false;
      }
      
      return false;
    }
    
    // 私有函数：查找并绑定关闭按钮
    function findAndBindCloseButton() {
      if (!dialogElement) return;
      
      const closeButtons = dialogElement.querySelectorAll('.dialog-zoomed-gallery__close-button');
      
      closeButtons.forEach(function(closeBtn) {
        // 使用私有属性标记，避免与其他脚本冲突
        const boundAttr = 'data-' + SCRIPT_ID + '-bound';
        
        if (closeBtn && !closeBtn.hasAttribute(boundAttr)) {
          closeBtn.setAttribute(boundAttr, 'true');
          
          // 添加多种事件监听，确保兼容性
          ['mousedown', 'touchstart', 'click'].forEach(function(eventType) {
            closeBtn.addEventListener(eventType, handleClose, {
              capture: true,
              passive: false
            });
          });
        }
      });
    }
    
    // 私有函数：主初始化函数
    function setupCloseButton() {
      // 查找元素
      zoomDialogElement = document.querySelector('#zoom-dialog-{{ block.id }}');
      if (!zoomDialogElement) return;
      
      dialogElement = zoomDialogElement.querySelector('dialog');
      if (!dialogElement) return;
      
      // 初始绑定
      findAndBindCloseButton();
      
      // 设置 DOM 变化观察器（仅在需要时）
      if (!mutationObserver) {
        mutationObserver = new MutationObserver(function(mutations) {
          // 使用节流，避免频繁触发
          let shouldUpdate = false;
          
          mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length > 0 || mutation.type === 'childList') {
              shouldUpdate = true;
            }
          });
          
          if (shouldUpdate) {
            findAndBindCloseButton();
          }
        });
        
        // 开始观察
        mutationObserver.observe(dialogElement, {
          childList: true,
          subtree: true
        });
      }
    }
    
    // 初始化
    function init() {
      try {
        // 立即执行一次
        setupCloseButton();
        
        // 延迟执行，确保元素已加载
        [500, 1000, 2000].forEach(function(delay) {
          const timer = setTimeout(function() {
            setupCloseButton();
          }, delay);
          timers.push(timer);
        });
      } catch (error) {
        // 静默处理初始化错误，不影响其他脚本
      }
    }
    
    // 页面加载完成后初始化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
      init();
    }
    
    // 页面卸载时清理资源
    window.addEventListener('beforeunload', cleanup, { once: true });
    
  })();
</script>

{% schema %}
{
  "name": "t:names.product_media",
  "tag": null,
  "settings": [
    {
      "type": "select",
      "id": "media_presentation",
      "label": "t:settings.type",
      "options": [
        {
          "value": "grid",
          "label": "t:options.grid"
        },
        {
          "value": "carousel",
          "label": "t:options.carousel"
        }
      ],
      "default": "grid",
      "info": "t:info.carousel_layout_on_mobile"
    },
    {
      "type": "header",
      "content": "t:content.grid",
      "visible_if": "{{ block.settings.media_presentation == 'grid' }}"
    },
    {
      "type": "select",
      "id": "media_columns",
      "label": "t:settings.columns",
      "options": [
        {
          "value": "one",
          "label": "t:options.one_number"
        },
        {
          "value": "two",
          "label": "t:options.two_number"
        }
      ],
      "default": "one",
      "visible_if": "{{ block.settings.media_presentation == 'grid' }}"
    },
    {
      "type": "range",
      "id": "image_gap",
      "label": "t:settings.gap",
      "min": 0,
      "max": 100,
      "unit": "px",
      "step": 1,
      "default": 0,
      "visible_if": "{{ block.settings.media_presentation == 'grid' }}"
    },
    {
      "type": "checkbox",
      "id": "large_first_image",
      "label": "t:settings.full_width_first_image",
      "default": false,
      "visible_if": "{{ block.settings.media_presentation == 'grid' and block.settings.media_columns == 'two' }}"
    },
    {
      "type": "header",
      "content": "t:content.carousel"
    },
    {
      "type": "select",
      "id": "icons_style",
      "label": "t:settings.icons",
      "options": [
        {
          "value": "arrow",
          "label": "t:options.arrows"
        },
        {
          "value": "chevron",
          "label": "t:options.chevrons"
        },
        {
          "value": "arrows_large",
          "label": "t:options.large_arrows"
        },
        {
          "value": "chevron_large",
          "label": "t:options.large_chevrons"
        }
      ],
      "default": "arrow",
      "visible_if": "{{ block.settings.media_presentation == 'carousel' }}"
    },
    {
      "type": "select",
      "id": "slideshow_controls_style",
      "label": "t:settings.pagination",
      "options": [
        {
          "value": "dots",
          "label": "t:options.dots"
        },
        {
          "value": "counter",
          "label": "t:options.counter"
        },
        {
          "value": "thumbnails",
          "label": "t:options.thumbnails"
        }
      ],
      "visible_if": "{{ block.settings.media_presentation == 'carousel' }}"
    },
    {
      "type": "select",
      "id": "slideshow_mobile_controls_style",
      "label": "t:settings.mobile_pagination",
      "options": [
        {
          "value": "dots",
          "label": "t:options.dots"
        },
        {
          "value": "counter",
          "label": "t:options.counter"
        },
        {
          "value": "hint",
          "label": "t:options.hint"
        }
      ]
    },
    {
      "type": "header",
      "content": "t:content.thumbnails",
      "visible_if": "{{ block.settings.media_presentation == 'carousel' and block.settings.slideshow_controls_style == 'thumbnails' }}"
    },
    {
      "type": "select",
      "id": "thumbnail_position",
      "label": "t:settings.position",
      "options": [
        {
          "value": "left",
          "label": "t:options.left"
        },
        {
          "value": "bottom",
          "label": "t:options.bottom"
        },
        {
          "value": "right",
          "label": "t:options.right"
        }
      ],
      "default": "bottom",
      "visible_if": "{{ block.settings.media_presentation == 'carousel' and block.settings.slideshow_controls_style == 'thumbnails' }}"
    },
    {
      "type": "range",
      "id": "thumbnail_width",
      "label": "t:settings.width",
      "min": 44,
      "max": 72,
      "step": 1,
      "unit": "px",
      "default": 64,
      "visible_if": "{{ block.settings.media_presentation == 'carousel' and block.settings.slideshow_controls_style == 'thumbnails' }}"
    },
    {
      "type": "header",
      "content": "t:content.media"
    },
    {
      "type": "select",
      "id": "aspect_ratio",
      "label": "t:settings.aspect_ratio",
      "options": [
        {
          "value": "adapt",
          "label": "t:options.auto"
        },
        {
          "value": "1/1.25",
          "label": "t:options.portrait"
        },
        {
          "value": "1",
          "label": "t:options.square"
        },
        {
          "value": "2/1",
          "label": "t:options.landscape"
        }
      ],
      "default": "adapt"
    },
    {
      "type": "checkbox",
      "id": "constrain_to_viewport",
      "label": "t:settings.limit_media_to_screen_height",
      "default": false
    },
    {
      "type": "select",
      "id": "media_fit",
      "label": "t:settings.media_fit",
      "options": [
        {
          "value": "cover",
          "label": "t:options.cover"
        },
        {
          "value": "contain",
          "label": "t:options.contain"
        }
      ],
      "default": "cover",
      "visible_if": "{{ block.settings.aspect_ratio == 'adapt' and block.settings.constrain_to_viewport == true }}"
    },
    {
      "type": "range",
      "id": "media_radius",
      "label": "t:settings.border_radius",
      "min": 0,
      "max": 32,
      "step": 1,
      "unit": "px",
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "extend_media",
      "label": "t:settings.extend_media_to_screen_edge",
      "default": true,
      "visible_if": "{{ section.settings.content_width == 'content-center-aligned' }}"
    },
    {
      "type": "checkbox",
      "id": "zoom",
      "label": "t:settings.enable_zoom",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "video_loop",
      "label": "t:settings.enable_video_looping",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "hide_variants",
      "default": false,
      "label": "t:settings.hide_unselected_variant_media"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "t:settings.left",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "t:settings.right",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "t:names.product_media"
    }
  ]
}
{% endschema %}

